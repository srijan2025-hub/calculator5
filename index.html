<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Shopping Calculator – Offline</title>
<meta name="theme-color" content="#0ea5e9" />
<link rel="manifest" href="manifest.webmanifest" />
<style>
  :root{
    --primary:#0ea5e9; --primary-weak:#38bdf8;
    --bg:#ffffff; --bg-dark:#000000;
    --text:#111827; --text-light:#e5e7eb;
  }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  html,body{height:100%;margin:0}
  body{background:var(--bg);color:var(--text);transition:background .3s,color .3s}
  body.dark{background:var(--bg-dark);color:var(--text-light)}
  .wrap{min-height:100%;padding:16px;max-width:1100px;margin:auto}
  .card{background:#fff;border:2px solid rgba(0,0,0,.08);border-radius:16px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.08)}
  body.dark .card{background:#0b0b0b;border-color:#1f2937;box-shadow:0 8px 35px rgba(0,0,0,.45)}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
  .field{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px}
  body.dark .field{background:#000;color:#e5e7eb;border-color:#2b2b2b}
  .btn{padding:8px 10px;border:1px solid #ccc;border-radius:8px;background:transparent;cursor:pointer}
  .seg{display:flex;gap:6px;border:2px solid var(--primary);padding:4px;border-radius:10px;position:relative}
  .thumb{position:absolute;top:4px;bottom:4px;width:50%;left:4px;background:var(--primary);border-radius:8px;transition:transform .25s}
  .seg[data-mode="amount"] .thumb{transform:translateX(100%)}
  .seg button{flex:1;border:0;background:transparent;font-weight:700;color:var(--primary);cursor:pointer;z-index:1}
  .seg[data-mode="quantity"] #btn-q,
  .seg[data-mode="amount"] #btn-a{color:#fff}
  .toggle{width:50px;height:26px;border-radius:9999px;background:#e5e7eb;position:relative;cursor:pointer}
  .dot{width:22px;height:22px;border-radius:9999px;background:#fff;position:absolute;top:2px;left:2px;transition:transform .3s}
  .toggle.active{background:var(--primary)} .toggle.active .dot{transform:translateX(24px)}
  .pill{background:linear-gradient(135deg,var(--primary-weak),var(--primary));color:#fff;border-radius:14px;text-align:center;padding:10px;box-shadow:0 8px 20px rgba(14,165,233,.35)}
  .add{border:2px dashed rgba(14,165,233,.6);border-radius:16px;min-height:160px;display:flex;align-items:center;justify-content:center;cursor:pointer}
  .hidden{display:none!important}
</style>
</head>
<body class="light">
<div class="wrap">
  <div class="card" style="margin-bottom:16px">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
      <div>
        <h1 style="margin:0;font-size:22px;font-weight:900">Shopping Calculator</h1>
        <p style="margin:2px 0 0;font-size:12px;opacity:.7">Multi-page • Global mode • Offline</p>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div id="seg" class="seg" data-mode="quantity">
          <div class="thumb"></div>
          <button id="btn-q" onclick="setMode('quantity')">Quantity</button>
          <button id="btn-a" onclick="setMode('amount')">Amount</button>
        </div>
        <div id="themeToggle" class="toggle"><div class="dot"></div></div>
      </div>
    </div>
  </div>
  <div id="tabs" class="grid"></div>
</div>

<template id="card-tpl">
  <div class="card" data-id="">
    <div style="display:flex;gap:6px;align-items:center;margin-bottom:6px">
      <input class="field" data-field="name" placeholder="Item (e.g., Rice)" />
      <button class="btn" data-action="delete">×</button>
    </div>
    <div style="margin-bottom:6px">
      <div style="font-size:12px;opacity:.7">Price per Unit (₹)</div>
      <div style="display:flex;gap:6px">
        <input class="field" data-field="price" type="number" min="0" step="any" placeholder="e.g., 100" />
        <select class="field" data-field="priceUnit" style="max-width:120px">
          <option value="kg">₹/kg</option>
          <option value="gram">₹/gram</option>
          <option value="100g">₹/100 g</option>
        </select>
      </div>
    </div>
    <div data-section="quantity">
      <div style="font-size:12px;opacity:.7">Your Budget (₹)</div>
      <input class="field" data-field="budget" type="number" min="0" step="any" placeholder="e.g., 500" />
    </div>
    <div data-section="amount" class="hidden">
      <div style="font-size:12px;opacity:.7">Quantity You Want</div>
      <div style="display:flex;gap:6px">
        <input class="field" data-field="qty" type="number" min="0" step="any" placeholder="e.g., 750" />
        <select class="field" data-field="qtyUnit" style="max-width:120px">
          <option value="gram">Gram</option>
          <option value="kg">Kg</option>
        </select>
      </div>
    </div>
    <div class="pill" style="margin-top:8px">
      <small data-field="label">Max Quantity You Can Buy</small>
      <div style="font-size:24px;font-weight:900">
        <span data-field="value">0.00</span>
        <span data-field="unit" style="font-size:14px;vertical-align:super">g</span>
      </div>
    </div>
  </div>
</template>

<template id="summary-tpl">
  <div class="card" style="text-align:center">
    <small data-field="summaryLabel" style="opacity:.7;text-transform:uppercase;font-size:12px">Total Quantity (all)</small>
    <div style="font-size:26px;font-weight:900">
      <span data-field="summaryValue">0.00</span>
      <span data-field="summaryUnit" style="font-size:14px;vertical-align:super">g</span>
    </div>
  </div>
</template>

<template id="add-tpl">
  <button class="add card"><b style="color:var(--primary)">+ Add New</b></button>
</template>

<script>
const $=(s,r=document)=>r.querySelector(s),$$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const defaultPage=()=>({id:Date.now()+Math.random(),name:'',price:'',priceUnit:'kg',budget:'',qty:'',qtyUnit:'gram'});
let state={mode:'quantity',pages:[defaultPage()]};

const LS_KEY='shopcalc-multi';
function save(){localStorage.setItem(LS_KEY,JSON.stringify(state));}
function load(){try{const d=JSON.parse(localStorage.getItem(LS_KEY));if(d&&Array.isArray(d.pages))state=d;}catch{}}

const clamp=n=>isFinite(n)&&n>=0?n:0;
function pricePerGram(p,u){p=clamp(p);return u==='kg'?p/1000:u==='100g'?p/100:p;}
function grams(q,u){return u==='kg'?clamp(q)*1000:clamp(q);}
function fmt(g){return g>=1000?{v:(g/1000).toFixed(3),u:'kg'}:{v:g.toFixed(2),u:'g'};}

function calc(p){
 const pg=pricePerGram(parseFloat(p.price),p.priceUnit);
 if(pg<=0)return state.mode==='quantity'?{l:'Max Quantity',v:'0.00',u:'g',r:0}:{l:'Total Cost',v:'0.00',u:'₹',r:0};
 if(state.mode==='quantity'){const b=clamp(parseFloat(p.budget)),g=b/pg,{v,u}=fmt(g);return{l:'Max Quantity',v,u,r:g};}
 const t=grams(parseFloat(p.qty),p.qtyUnit)*pg;return{l:'Total Cost',v:t.toFixed(2),u:'₹',r:t};
}

function summary(){
 if(state.mode==='quantity'){const g=state.pages.reduce((a,p)=>a+calc(p).r,0);const {v,u}=fmt(g);return{l:'Total Quantity (all)',v,u};}
 const t=state.pages.reduce((a,p)=>a+calc(p).r,0);return{l:'Total Amount (all)',v:t.toFixed(2),u:'₹'};}
 
const tabs=$('#tabs');
function render(){
 tabs.innerHTML='';
 for(const p of state.pages){
  const f=document.importNode($('#card-tpl').content,true),r=f.firstElementChild;
  r.dataset.id=p.id;
  $('[data-field=\"name\"]',r).value=p.name;
  $('[data-field=\"price\"]',r).value=p.price;
  $('[data-field=\"priceUnit\"]',r).value=p.priceUnit;
  $('[data-field=\"budget\"]',r).value=p.budget;
  $('[data-field=\"qty\"]',r).value=p.qty;
  $('[data-field=\"qtyUnit\"]',r).value=p.qtyUnit;
  $('[data-section=\"quantity\"]',r).classList.toggle('hidden',state.mode!=='quantity');
  $('[data-section=\"amount\"]',r).classList.toggle('hidden',state.mode!=='amount');
  const c=calc(p);
  $('[data-field=\"label\"]',r).textContent=c.l;
  $('[data-field=\"value\"]',r).textContent=c.v;
  $('[data-field=\"unit\"]',r).textContent=c.u;
  $('[data-action=\"delete\"]',r).onclick=()=>remove(p.id);
  $$('[data-field]',r).forEach(el=>el.oninput=()=>{p[el.dataset.field]=el.value;save();render();});
  tabs.appendChild(f);
 }
 if(state.pages.length){
  const s=document.importNode($('#summary-tpl').content,true),sr=s.firstElementChild;
  const sm=summary();$('[data-field=\"summaryLabel\"]',sr).textContent=sm.l;$('[data-field=\"summaryValue\"]',sr).textContent=sm.v;$('[data-field=\"summaryUnit\"]',sr).textContent=sm.u;
  tabs.appendChild(s);
 }
 const add=document.importNode($('#add-tpl').content,true);add.firstElementChild.onclick=addPage;tabs.appendChild(add);
 $('#seg').setAttribute('data-mode',state.mode);
}
function addPage(){state.pages.push(defaultPage());save();render();}
function remove(id){state.pages.length===1?state.pages=[defaultPage()]:state.pages=state.pages.filter(p=>p.id!==id);save();render();}
function setMode(m){state.mode=m;save();render();}window.setMode=setMode;

const theme=$('#themeToggle');
function apply(t){document.body.classList.toggle('dark',t==='dark');theme.classList.toggle('active',t==='dark');localStorage.setItem('calc-theme',t);}
theme.onclick=()=>apply(document.body.classList.contains('dark')?'light':'dark');

if('serviceWorker'in navigator)window.addEventListener('load',()=>navigator.serviceWorker.register('sw.js'));

window.addEventListener('load',()=>{
 const t=localStorage.getItem('calc-theme');apply(t??(window.matchMedia('(prefers-color-scheme:dark)').matches?'dark':'light'));
 load();render();
});
</script>
</body>
</html>
