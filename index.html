<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Shopping Calculator – Offline</title>
<meta name="theme-color" content="#0ea5e9" />
<link rel="manifest" href="manifest.webmanifest" />
<style>
  :root{
    --primary:#0ea5e9; --primary-weak:#38bdf8;
    --bg:#ffffff; --bg-dark:#000000;
    --text:#111827; --text-light:#e5e7eb;
  }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  html,body{height:100%;margin:0}
  body{background:var(--bg);color:var(--text);transition:background .3s,color .3s}
  body.dark{background:var(--bg-dark);color:var(--text-light)}
  .wrap{min-height:100%;padding:16px;max-width:1100px;margin:auto}
  .card{background:#fff;border:2px solid rgba(0,0,0,.08);border-radius:16px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.08)}
  body.dark .card{background:#0b0b0b;border-color:#1f2937;box-shadow:0 8px 35px rgba(0,0,0,.45)}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
  .field{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px}
  body.dark .field{background:#000;color:#e5e7eb;border-color:#2b2b2b}
  .btn{padding:8px 10px;border:1px solid #ccc;border-radius:8px;background:transparent;cursor:pointer}
  .seg{display:flex;gap:6px;border:2px solid var(--primary);padding:4px;border-radius:10px;position:relative}
  .thumb{position:absolute;top:4px;bottom:4px;width:50%;left:4px;background:var(--primary);border-radius:8px;transition:transform .25s}
  .seg[data-mode="amount"] .thumb{transform:translateX(100%)}
  .seg button{flex:1;border:0;background:transparent;font-weight:700;color:var(--primary);cursor:pointer;z-index:1}
  .seg[data-mode="quantity"] #btn-q,
  .seg[data-mode="amount"] #btn-a{color:#fff}
  .toggle{width:50px;height:26px;border-radius:9999px;background:#e5e7eb;position:relative;cursor:pointer}
  .dot{width:22px;height:22px;border-radius:9999px;background:#fff;position:absolute;top:2px;left:2px;transition:transform .3s}
  .toggle.active{background:var(--primary)} .toggle.active .dot{transform:translateX(24px)}
  .pill{background:linear-gradient(135deg,var(--primary-weak),var(--primary));color:#fff;border-radius:14px;text-align:center;padding:10px;box-shadow:0 8px 20px rgba(14,165,233,.35)}
  .add{border:2px dashed rgba(14,165,233,.6);border-radius:16px;min-height:160px;display:flex;align-items:center;justify-content:center;cursor:pointer}
  .hidden{display:none!important}
</style>
</head>
<body class="light">
<div class="wrap">
  <div class="card" style="margin-bottom:16px">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
      <div>
        <h1 style="margin:0;font-size:22px;font-weight:900">Shopping Calculator</h1>
        <p style="margin:2px 0 0;font-size:12px;opacity:.7">Multi-page • Global mode • Offline</p>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div id="seg" class="seg" data-mode="quantity">
          <div class="thumb"></div>
          <button id="btn-q" onclick="setMode('quantity')">Quantity</button>
          <button id="btn-a" onclick="setMode('amount')">Amount</button>
        </div>
        <div id="themeToggle" class="toggle"><div class="dot"></div></div>
      </div>
    </div>
  </div>
  <div id="tabs" class="grid"></div>
</div>

<template id="card-tpl">
  <div class="card" data-id="">
    <div style="display:flex;gap:6px;align-items:center;margin-bottom:6px">
      <input class="field" data-field="name" placeholder="Item (e.g., Rice)" />
      <button class="btn" data-action="delete">×</button>
    </div>
    <div style="margin-bottom:6px">
      <div style="font-size:12px;opacity:.7">Price per Unit (₹)</div>
      <div style="display:flex;gap:6px">
        <input class="field" data-field="price" type="number" min="0" step="any" placeholder="e.g., 100" />
        <select class="field" data-field="priceUnit" style="max-width:120px">
          <option value="kg">₹/kg</option>
          <option value="gram">₹/gram</option>
          <option value="100g">₹/100 g</option>
        </select>
      </div>
    </div>
    <div data-section="quantity">
      <div style="font-size:12px;opacity:.7">Your Budget (₹)</div>
      <input class="field" data-field="budget" type="number" min="0" step="any" placeholder="e.g., 500" />
    </div>
    <div data-section="amount" class="hidden">
      <div style="font-size:12px;opacity:.7">Quantity You Want</div>
      <div style="display:flex;gap:6px">
        <input class="field" data-field="qty" type="number" min="0" step="any" placeholder="e.g., 750" />
        <select class="field" data-field="qtyUnit" style="max-width:120px">
          <option value="gram">Gram</option>
          <option value="kg">Kg</option>
        </select>
      </div>
    </div>
    <div class="pill" style="margin-top:8px">
      <small data-field="label">Max Quantity You Can Buy</small>
      <div style="font-size:24px;font-weight:900">
        <span data-field="value">0.00</span>
        <span data-field="unit" style="font-size:14px;vertical-align:super">g</span>
      </div>
    </div>
  </div>
</template>

<template id="summary-tpl">
  <div class="card" style="text-align:center">
    <small data-field="summaryLabel" style="opacity:.7;text-transform:uppercase;font-size:12px">Total Quantity (all)</small>
    <div style="font-size:26px;font-weight:900">
      <span data-field="summaryValue">0.00</span>
      <span data-field="summaryUnit" style="font-size:14px;vertical-align:super">g</span>
    </div>
  </div>
</template>

<template id="add-tpl">
  <button class="add card"><b style="color:var(--primary)">+ Add New</b></button>
</template>

  <script>
const $=(s,r=document)=>r.querySelector(s),$$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const defaultPage=()=>({id:Date.now()+Math.random(),name:'',price:'',priceUnit:'kg',budget:'',qty:'',qtyUnit:'gram'});
let state={mode:'quantity',pages:[defaultPage()]};

const LS_KEY='shopcalc-multi';
function save(){localStorage.setItem(LS_KEY,JSON.stringify(state));}
function load(){try{const d=JSON.parse(localStorage.getItem(LS_KEY));if(d&&Array.isArray(d.pages)&&(['quantity','amount'].includes(d.mode)))state=d;}catch{}}

const clamp=n=>isFinite(n)&&n>=0?n:0;
function pricePerGram(p,u){p=clamp(p);return u==='kg'?p/1000:u==='100g'?p/100:p;}
function grams(q,u){return u==='kg'?clamp(q)*1000:clamp(q);}
function fmt(g){return g>=1000?{v:(g/1000).toFixed(3),u:'kg'}:{v:g.toFixed(2),u:'g'};}

function calcPage(page){
  const pg=pricePerGram(parseFloat(page.price),page.priceUnit);
  if(pg<=0) return state.mode==='quantity'
    ? {label:'Max Quantity', v:'0.00', u:'g', raw:0}
    : {label:'Total Cost',   v:'0.00', u:'₹', raw:0};
  if(state.mode==='quantity'){
    const g=clamp(parseFloat(page.budget))/pg;
    const {v,u}=fmt(g);
    return {label:'Max Quantity', v,u, raw:g};
  }else{
    const t=grams(parseFloat(page.qty),page.qtyUnit)*pg;
    return {label:'Total Cost', v:t.toFixed(2), u:'₹', raw:t};
  }
}

function calcSummary(){
  if(state.mode==='quantity'){
    const totalG=state.pages.reduce((a,p)=>a+calcPage(p).raw,0);
    const {v,u}=fmt(totalG);
    return {label:'Total Quantity (all)', v:u==='kg'?v:v, u};
  }else{
    const total=state.pages.reduce((a,p)=>a+calcPage(p).raw,0);
    return {label:'Total Amount (all)', v:total.toFixed(2), u:'₹'};
  }
}

/* ---------- Rendering (structural) ---------- */
const tabs=$('#tabs');

function render(){
  tabs.innerHTML='';
  for(const p of state.pages){
    const frag=document.importNode($('#card-tpl').content,true);
    const card=frag.firstElementChild;
    card.dataset.id=p.id;

    // set values
    $('[data-field="name"]',card).value=p.name;
    $('[data-field="price"]',card).value=p.price;
    $('[data-field="priceUnit"]',card).value=p.priceUnit;
    $('[data-field="budget"]',card).value=p.budget;
    $('[data-field="qty"]',card).value=p.qty;
    $('[data-field="qtyUnit"]',card).value=p.qtyUnit;

    // show sections based on mode
    $('[data-section="quantity"]',card).classList.toggle('hidden',state.mode!=='quantity');
    $('[data-section="amount"]',card).classList.toggle('hidden',state.mode!=='amount');

    // initial outputs
    writeOutputsForCard(card, p);

    // listeners (incremental updates, NO full render)
    $('[data-action="delete"]',card).addEventListener('click', ()=>remove(p.id));
    $$('[data-field]',card).forEach(el=>{
      el.addEventListener('input', ()=>{
        const key=el.dataset.field;
        const page=findPageById(card.dataset.id); if(!page) return;
        page[key]=el.value;
        save();
        writeOutputsForCard(card, page);  // only update this card
        writeSummary();                   // and the summary
      });
      // Also handle 'change' for selects (Android sometimes defers value until change)
      if(el.tagName==='SELECT'){
        el.addEventListener('change', ()=>{
          const key=el.dataset.field;
          const page=findPageById(card.dataset.id); if(!page) return;
          page[key]=el.value;
          save();
          writeOutputsForCard(card, page);
          writeSummary();
        });
      }
    });

    tabs.appendChild(frag);
  }

  // summary card
  const sFrag=document.importNode($('#summary-tpl').content,true);
  sFrag.firstElementChild.id='summary-card';
  tabs.appendChild(sFrag);
  writeSummary();

  // add new
  const addFrag=document.importNode($('#add-tpl').content,true);
  addFrag.firstElementChild.addEventListener('click', addPage);
  tabs.appendChild(addFrag);

  // reflect mode UI
  $('#seg').setAttribute('data-mode',state.mode);
}

/* ---------- Incremental writers ---------- */
function writeOutputsForCard(cardEl, page){
  const c=calcPage(page);
  $('[data-field="label"]',cardEl).textContent=c.label;
  $('[data-field="value"]',cardEl).textContent=c.v;
  $('[data-field="unit"]',cardEl).textContent=c.u;
}
function writeSummary(){
  const sEl=$('#summary-card'); if(!sEl) return;
  const s=calcSummary();
  $('[data-field="summaryLabel"]',sEl).textContent=s.label;
  $('[data-field="summaryValue"]',sEl).textContent=s.v;
  $('[data-field="summaryUnit"]',sEl).textContent=s.u;
}

/* ---------- Helpers ---------- */
function findPageById(id){ return state.pages.find(p=>String(p.id)===String(id)); }

/* ---------- Mutations that DO re-render ---------- */
function addPage(){ state.pages.push(defaultPage()); save(); render(); }
function remove(id){
  if(state.pages.length===1){ state.pages=[defaultPage()]; }
  else{ state.pages=state.pages.filter(p=>p.id!==id); }
  save(); render();
}
function setMode(m){ state.mode=m; save(); render(); }
window.setMode=setMode;

/* ---------- Theme ---------- */
const theme=$('#themeToggle');
function applyTheme(t){
  document.body.classList.toggle('dark',t==='dark');
  theme.classList.toggle('active',t==='dark');
  localStorage.setItem('calc-theme',t);
}
theme.addEventListener('click',()=>applyTheme(document.body.classList.contains('dark')?'light':'dark'));

/* ---------- Service worker ---------- */
if('serviceWorker'in navigator){
  window.addEventListener('load',()=>navigator.serviceWorker.register('sw.js').catch(console.error));
}

/* ---------- Init ---------- */
window.addEventListener('load',()=>{
  const t=localStorage.getItem('calc-theme');
  applyTheme(t ?? (window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));
  load();
  render();
});
</script>
</body>
</html>
